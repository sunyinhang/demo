<div data-container="personalInform">
    <component is="tab-applyQuota" active="realName personal"></component>
    <form>
        <component is="bv-accordion" :entity="entity" v-bind="config"></component>
        <component is="bv-form" :entity="entity" :key="tags.formKey" v-bind="operateConfig"></component>
    </form>
</div>
<script type="text/javascript">
    require(['jquery', 'util', 'Const', 'bvAccordion', 'bvForm', 'bvUpload'], function($, util, Const) {
        util.title('个人资料');
        var vm = util.bind({
            container: 'personalInform',
            data: {
                tags: {
                    formKey: 'personalInformForm'
                },
                entity: {
                },
                config: {
                    items: [
                        {
                            title: '个人信息',
                            type: 'form',
                            config: {
                                clazz: 'form-align-right',
                                layout: 'inline',
                                container: 'div',
                                columns: [
                                    {
                                        head: '婚姻状况',
                                        name: 'maritalStatus',
                                        edit: {
                                            type: 'select'
                                        },
                                        config: {
                                            attr: {
                                                placeholder: '请选择'
                                            },
                                            preset: 'json',
                                            choose: '#maritalStatus',
                                            validate: {
                                                //required: '婚姻状况不能为空'
                                            }
                                        }
                                    },
                                    {
                                        head: '居住地址',
                                        name: 'liveAddress',
                                        edit: {
                                            type: 'picker'
                                        },
                                        config: {
                                            attr: {
                                                placeholder: '请选择居住地址'
                                            },
                                            validate: {
                                                //required: '居住地址不能为空'
                                            },
                                            code: 'areaCode',
                                            desc: 'areaName',
                                            // cache: true,
                                            initOption: {
                                                areaCode: '',
                                                areaName: '请选择'
                                            },
                                            choose: [
                                                {
                                                    items: [],
                                                    onInit: function () {
                                                        var _vm = this;
                                                        app.getArea('', function (items) {
                                                            _vm.changeItems(0, items);
                                                        });
                                                    },
                                                    onChange: function (value, values) {
                                                        if (util.isEmpty(value)) {
                                                            this.changeItems(1, []);
                                                        } else {
                                                            var _vm = this;
                                                            app.getArea(value, function (items) {
                                                                _vm.changeItems(1, items);
                                                            });
                                                        }
                                                    }
                                                },
                                                {
                                                    items: [],
                                                    onChange: function (value, values) {
                                                        if (util.isEmpty(value)) {
                                                            this.changeItems(2, []);
                                                        } else {
                                                            var _vm = this;
                                                            app.getArea(value, function (items) {
                                                                _vm.changeItems(2, items);
                                                            });
                                                        }
                                                    }
                                                },
                                                {
                                                    items: []
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        name: 'liveAddr',
                                        config: {
                                            attr: {
                                                placeholder: '居住详细地址',
                                                maxlength: '#address'
                                            },
                                            validate: {
                                                required: '居住详细地址不能为空'
                                            }
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            title: '单位信息',
                            type: 'form',
                            config: {
                                clazz: 'form-align-right',
                                layout: 'inline',
                                columns: [
                                    {
                                        head: '工作单位',
                                        name: 'officeName',
                                        config: {
                                            attr: {
                                                maxlength: '#officeName'
                                            },
                                            validate: {
                                                required: '请输入工作单位'
                                            }
                                        }
                                    },
                                    {
                                        head: '单位电话',
                                        name: 'officeTel',
                                        config: {
                                            attr: {
                                                placeholder: '请输入11-12位单位电话',
                                                maxlength: '#phone'
                                            },
                                            validate: {
                                                required: '单位电话不能为空',
                                                custom: {
                                                    code: 'phone',
                                                    desc: '请输入正确的单位电话'
                                                }
                                            }
                                        }
                                    },
                                    {
                                        head: '单位地址',
                                        name: 'officeAddress',
                                        edit: {
                                            type: 'picker'
                                        },
                                        config: {
                                            attr: {
                                                placeholder: '请选择单位地址'
                                            },
                                            validate: {
                                                //required: '单位地址不能为空'
                                            },
                                            code: 'areaCode',
                                            desc: 'areaName',
                                            // cache: true,
                                            initOption: {
                                                areaCode: '',
                                                areaName: '请选择'
                                            },
                                            choose: [
                                                {
                                                    items: [],
                                                    onInit: function () {
                                                        var _vm = this;
                                                        app.getArea('', function (items) {
                                                            _vm.changeItems(0, items);
                                                        });
                                                    },
                                                    onChange: function (value, values) {
                                                        if (util.isEmpty(value)) {
                                                            this.changeItems(1, []);
                                                        } else {
                                                            var _vm = this;
                                                            app.getArea(value, function (items) {
                                                                _vm.changeItems(1, items);
                                                            });
                                                        }
                                                    }
                                                },
                                                {
                                                    items: [],
                                                    onChange: function (value, values) {
                                                        if (util.isEmpty(value)) {
                                                            this.changeItems(2, []);
                                                        } else {
                                                            var _vm = this;
                                                            app.getArea(value, function (items) {
                                                                _vm.changeItems(2, items);
                                                            });
                                                        }
                                                    }
                                                },
                                                {
                                                    items: []
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        name: 'officeAddr',
                                        config: {
                                            attr: {
                                                placeholder: '单位详细地址',
                                                maxlength: '#address'
                                            },
                                            validate: {
                                                required: '单位详细地址不能为空'
                                            }
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            title: '紧急联系人',
                            type: 'form',
                            config: {
                                clazz: 'form-align-right',
                                layout: 'inline',
                                container: 'div',
                                columns: [
                                    {
                                        head: '联系人关系一',
                                        name: 'relationType1',
                                        edit: {
                                            type: 'select'
                                        },
                                        config: {
                                            attr: {
                                                placeholder: '请选择'
                                            },
                                            preset: 'json',
                                            choose: '#relationType',
                                            validate: {
                                                required: '请选择紧急联系人关系'
                                            }
                                        }
                                    },
                                    {
                                        head: '姓名',
                                        name: 'contactName1',
                                        config: {
                                            attr: {
                                                placeholder: '请输入联系人姓名',
                                                maxlength: '#name'
                                            },
                                            validate: {
                                                required: '紧急联系人姓名不能为空'
                                            }
                                        }
                                    },
                                    {
                                        head: '联系电话',
                                        name: 'contactMobile1',
                                        config: {
                                            attr: {
                                                placeholder: '请输入联系电话',
                                                maxlength: '#phone'
                                            },
                                            validate: {
                                                required: '紧急联系人不能为空',
                                                custom: {
                                                    code: 'phone',
                                                    desc: '请输入正确的紧急联系人联系方式'
                                                }
                                            }
                                        }
                                    },
                                    {
                                        head: '联系人关系二',
                                        name: 'relationType2',
                                        edit: {
                                            type: 'select'
                                        },
                                        config: {
                                            attr: {
                                                placeholder: '请选择'
                                            },
                                            preset: 'json',
                                            choose: '#relationType',
                                            validate: {
                                                //required: '请选择紧急联系人关系'
                                            }
                                        }
                                    },
                                    {
                                        head: '姓名',
                                        name: 'contactName2',
                                        config: {
                                            attr: {
                                                placeholder: '请输入联系人姓名',
                                                maxlength: '#name'
                                            },
                                            validate: {
                                                required: '紧急联系人姓名不能为空'
                                            }
                                        }
                                    },
                                    {
                                        head: '联系电话',
                                        name: 'contactMobile2',
                                        config: {
                                            attr: {
                                                placeholder: '请输入联系电话',
                                                maxlength: '#phone'
                                            },
                                            validate: {
                                                required: '紧急联系人不能为空',
                                                custom: {
                                                    code: 'phone',
                                                    desc: '请输入正确的紧急联系人联系方式'
                                                }
                                            }
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            title: '选传影像',
                            type: 'form',
                            config: {
                                columns: [
                                    {
                                        head: '选传影像1',
                                        name: 'p1',
                                        edit: {
                                            type: 'upload'
                                        },
                                        config: {
                                            clazz: 'upload-multiple',
                                            files: [{}, {}],
                                            autoIncrease: true,
                                            autoUpload: false
                                        }
                                    },
                                    {
                                        head: '选传影像2',
                                        name: 'p2',
                                        edit: {
                                            type: 'upload'
                                        },
                                        config: {
                                            clazz: 'upload-multiple',
                                            files: [{}, {}],
                                            autoIncrease: true,
                                            autoUpload: false
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                },
                operateConfig: {
                    type: 'form',
                    container: 'div',
                    operates: [
                        {
                            text: '下一步',
                            clazz: 'primary',
                            click: function (event, editType, entity) {
                                util.post({
                                    url: "/saveAllCustExtInfo",
                                    data:{
                                        liveAddress_code: entity.liveAddress_code,
                                        officeAddress_code: entity.officeAddress_code,
                                        maritalStatus: entity.maritalStatus,
                                        liveAddr: entity.liveAddr,
                                        officeName: entity.officeName,
                                        officeTel: entity.officeTel,
                                        officeAddr: entity.officeAddr,
                                        id_one: entity.id1,
                                        relationType_one: entity.relationType1,
                                        contactName_one: entity.contactName1,
                                        contactMobile_one: entity.contactMobile1,
                                        id_two: entity.id2,
                                        relationType_two: entity.relationType2,
                                        contactName_two: entity.contactName2,
                                        contactMobile_two: entity.contactMobile2,
                                        dataFrom: 'app_person'
                                    },
                                    success:function(res){
                                        //1：通过人脸识别，并已设置支付密码
                                        //2：通过人脸识别，但没有设置支付密码
                                        //3. 未通过人脸识别，剩余次数为0，不能再做人脸识别，录单终止
                                        //4：未通过人脸识别，剩余次数为0，不能再做人脸识别，但可以上传替代影像
                                        //5. 跳转人脸识别
                                        if(res.body.flag == '1'){
                                            util.redirect({
                                                title: '确认支付密码',
                                                url: '/applyQuota/confirmPayPsd.html',
                                                back: false
                                            });
                                        }else if(res.body.flag == '2'){
                                            util.redirect({
                                                title: '设置支付密码',
                                                url: '/applyQuota/setPayPsd.html',
                                                back: false
                                            });
                                        }else if(res.body.flag == '3'){
                                            //TODO

                                        }else if(res.body.flag == '4'){
                                            util.redirect({
                                                title: '手持身份证',
                                                url: '/applyQuota/handholdIdCard.html',
                                                back: false
                                            });
                                        }else if(res.body.flag == '5'){
                                            util.redirect({
                                                title: '人脸识别',
                                                url: '/applyQuota/identityVrfic.html',
                                                back: false
                                            });
                                        }
                                    }
                                });
                            }
                        }
                    ]
                }
            }
        });
        util.post({
            url: "/getAllCustExtInfo",
            success:function(res){
                util.refresh({
                    vm: util.vm(vm, vm.tags.formKey),
                    entity: {
                        maritalStatus: res.CustExtInfoMap.body.maritalStatus,
                        liveAddress_code: res.CustExtInfoMap.body.liveProvince+ ','+res.CustExtInfoMap.body.liveCity+','+res.CustExtInfoMap.body.liveArea,
                        liveAddress: res.CustExtInfoMap.body.liveProvinceName+ res.CustExtInfoMap.body.liveCityName+res.CustExtInfoMap.body.liveAreaName,
                        liveAddr: res.CustExtInfoMap.body.liveAddr,
                        officeName: res.CustExtInfoMap.body.officeName,
                        officeTel: res.CustExtInfoMap.body.officeTel,
                        officeAddr: res.CustExtInfoMap.body.officeAddr,
                        officeAddress_code: res.CustExtInfoMap.body.officeProvince+','+ res.CustExtInfoMap.body.officeCity+','+res.CustExtInfoMap.body.officeArea,
                        officeAddress: res.CustExtInfoMap.body.officeProvinceName+ res.CustExtInfoMap.body.officeCity+res.CustExtInfoMap.body.officeAreaName,
                        id1: res.CustExtInfoMap.body.lxrList[0].id,
                        relationType1: res.CustExtInfoMap.body.lxrList[0].relationType,
                        contactName1: res.CustExtInfoMap.body.lxrList[0].contactName,
                        contactMobile1: res.CustExtInfoMap.body.lxrList[0].contactMobile,
                        id2: res.CustExtInfoMap.body.lxrList[1].id,
                        relationType2: res.CustExtInfoMap.body.lxrList[1].relationType,
                        contactName2: res.CustExtInfoMap.body.lxrList[1].contactName,
                        contactMobile2: res.CustExtInfoMap.body.lxrList[1].contactMobile
                    }
                });
                if(! util.isEmpty(res.CustExtInfoMap.body.lxrList[0])){
                    util.refresh({
                        vm: util.vm(vm, vm.tags.formKey),
                        entity: {
                            id1: res.CustExtInfoMap.body.lxrList[0].id,
                            relationType1: res.CustExtInfoMap.body.lxrList[0].relationType,
                            contactName1: res.CustExtInfoMap.body.lxrList[0].contactName,
                            contactMobile1: res.CustExtInfoMap.body.lxrList[0].contactMobile,
                        }
                    });
                }
                if(! util.isEmpty(res.CustExtInfoMap.body.lxrList[1])){
                    util.refresh({
                        vm: util.vm(vm, vm.tags.formKey),
                        entity: {
                            id2: res.CustExtInfoMap.body.lxrList[1].id,
                            relationType2: res.CustExtInfoMap.body.lxrList[1].relationType,
                            contactName2: res.CustExtInfoMap.body.lxrList[1].contactName,
                            contactMobile2: res.CustExtInfoMap.body.lxrList[1].contactMobile
                        }
                    });
                }
            }
        });
    });
</script>