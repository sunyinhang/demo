<div class="bv-align-center" data-container="tiedBnkCrd">
    <component is="tab-applyQuota"></component>
    <component is="bv-form" class="form-align-right" :key="tags.formKey" :entity="entity" v-bind="formConfig"></component>
</div>
<script type="text/javascript">
    require(['jquery', 'util', 'Const', 'bvUpload', 'bvForm'], function($, util, Const) {
        //获取持卡人姓名
        var param = util.cache();

        var vm = util.bind({
            container: 'tiedBnkCrd',
            data: {
                tags: {
                    formKey: 'tiedBnkCrdForm'
                },
                entity: {
                    cardholder: param.name
                },
                formConfig: {
                    layout: 'inline',
                    columns: [
                        {
                            head: '持卡人',
                            name: 'cardholder',
                            config: {
                                value: param && param.name,
                                attr: {
                                    readonly: 'readonly'
                                },
                                validate: {
                                    required: '持卡人不能为空'
                                }
                            },
                            operate: {
                                type: 'hint',
                                click: function () {
                                    util.alert('为了您的账户安全，请您绑定本人银行卡');
                                }
                            }
                        },{
                            head: '卡号',
                            name: 'cardnumber',
                            config: {
                                attr: {
                                    placeholder: '请输入卡号'
                                },
                                validate: {
                                    required: '请输入银行卡卡号'
                                },
                                blur: function (event, val, entity) {
                                    if (util.isEmpty(entity.cardnumber)) {
                                        util.alert('请先输入银行卡号');
                                    }else{
                                        util.get({
                                            url: util.mix("/getCardInfo", {
                                                cardNo: entity.cardnumber
                                            }),
                                            success:function(res){
                                                util.refresh({
                                                    vm: util.vm(vm, vm.tags.formKey),
                                                    entity: {
                                                        cardtype: res.body.bankName+res.body.cardType
                                                    }
                                                });
                                            }
                                        });
                                    }
                                }
                            }
                        },{
                            head: '卡类型',
                            name: 'cardtype',
                            config: {
                                attr: {
                                    readonly: 'readonly',
                                },
                                validate: {
                                    required: '卡类型不能为空'
                                },operate: {
                                    click: function (event,entity) {
                                        if (util.isEmpty(entity.cardnumber)) {
                                            util.alert('请先输入银行卡号');
                                        }
                                    }
                                }
                            },
                            operate: {
                                type: 'hint',
                                click: function () {
                                    util.alert('由于银行扣款要求，现已支持中国工商银行，中国邮政储蓄银行，中国农业银行，中国银行，中国建设银行，广东发展银行，兴业银行， 招商银行，交通银行，中信银行，中国光大银行，华夏银行，中国民生银行，平安银行，上海浦东发展银行，北京银行，上海银行，青岛银行');
                                }
                            }
                        },{
                            head: '开户省市',
                            name: 'account',
                            edit: {
                                type: 'picker'
                            },
                            config: {
                                attr: {
                                    placeholder: '请选择开户省市'
                                },
                                validate: {
                                    required: '开户省市不能为空'
                                },
                                code: 'areaCode',
                                desc: 'areaName',
                                // cache: true,
                                initOption: {
                                    areaCode: '',
                                    areaName: '请选择'
                                },
                                choose: [
                                    {
                                        items: [],
                                        onInit: function () {
                                            var _vm = this;
                                            app.getArea('', function (items) {
                                                _vm.changeItems(0, items);
                                            });
                                        },
                                        onChange: function (value, values) {
                                            if (util.isEmpty(value)) {
                                                this.changeItems(1, []);
                                            } else {
                                                var _vm = this;
                                                app.getArea(value, function (items) {
                                                    _vm.changeItems(1, items);
                                                });
                                            }
                                        }
                                    },
                                    {
                                        items: [],
                                        onChange: function (value, values) {
                                            if (util.isEmpty(value)) {
                                                this.changeItems(2, []);
                                            } else {
                                                var _vm = this;
                                                app.getArea(value, function (items) {
                                                    _vm.changeItems(2, items);
                                                });
                                            }
                                        }
                                    },
                                    {
                                        items: []
                                    }
                                ]
                            }
                        },{
                            head: '预留手机号',
                            name: 'mobile',
                            config: {
                                attr: {
                                    placeholder: '请输入银行预留手机号'
                                },
                                validate: {
                                    required: '请输入银行预留手机号'
                                }
                            }
                        },{
                            head: '验证码',
                            name: 'verifyNo',
                            config: {
                                attr: {
                                    placeholder: '请输入验证码'
                                },
                                validate: {
                                    required: '请输入验证码'
                                }
                            },
                            operate: {
                                text: '获取验证码',
                                click: function (event,entity) {
                                    util.countdown($(event.target), {
                                        text: '获取验证码',
                                        second: 60
                                    });
                                    util.get({
                                        url: util.mix('/sendMsg',{
                                            phone: entity.mobile
                                        })
                                    });
                                }
                            },
                            hint: '#card'
                        }
                    ],
                    operates: [
                        {
                            text: '下一步',
                            clazz: 'primary',
                            click: function (event, editType, entity) {
                                util.post({
                                    url: '/realAuthentication',
                                    data:{
                                        cityCode: entity.account,
                                        cardnumber: entity.cardnumber,
                                        mobile: entity.mobile,
                                        verifyNo: entity.verifyNo,
                                    },
                                    success:function(res){
                                        util.cache({
                                            mobile: entity.mobile
                                        });
                                        util.redirect({
                                            title: '个人资料',
                                            url: '/applyQuota/personalInform.html',
                                            back: false
                                        });
                                    }
                                });
                            }
                        }
                    ]
                }
            }
        });
    });
</script>
<!--此卡为默认放款卡和还款卡,如果想更换默认还款卡，可以在个人中心-个人资料-银行卡中绑定并设置-->
