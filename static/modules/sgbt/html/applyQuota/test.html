<style type="text/css">
	.add_photo{ float: left; position: relative; width: 5.7rem; height: 6rem; }
	.add_photoImg img { position:absolute; top:0px; left:0px; width: 5.7rem; min-height:5.85rem; }
	.add_photoFile input{ position: absolute; top: 0px; left: 0px; width: 5.7rem; height: 6rem; opacity: 0; }

	#div1{ float: left; margin-left: 15px; }
</style>
<form enctype="multipart/form-data" id="handForm" name="handForm" ms-validate="@validate">
	<div class="add_photo">
	    <div class="add_photoImg">
	        <img src="images/applyQuota/add_photo.png" />
	    </div>
	    <div class="add_photoFile">
	     	<input type="file" class="upload" id="f_UploadImage">	   	    
	    </div>
	</div>
	<div id="div1"></div>
</form>
    
    <script type="text/javascript">
        /*本地缓存操作*/
        var envObj = {
            SaveLocals: function (name, data) {
                localStorage.setItem(name, data);
            },
            GetLocals: function (name) {
                return localStorage.getItem(name);
            },
            RemoveLocals: function (name) {
                localStorage.removeItem(name);
            }
        }
    </script>
    <script type="text/javascript">
         var _URL = window.URL || window.webkitURL;
        $(function () {
            var imgobj = {};
            var formData = new FormData();
            $("#f_UploadImage").on('change', function () {
                var file, img, imgName, src, src2, reader;
                if ((file = this.files[0])) {
                    //生成图片唯一名字 方便删除
                    imgName = "file" + (new Date).getTime();
                    console.log(imgName);
                    //把图片内容放到formdata中保存，key/value形式
                    formData.append(imgName, file);//formData对象
                    //获取img的src用于展示
                    src = _URL.createObjectURL(file);//把这个url放到上面展示

                    img = document.createElement("img");
                    img.src = src;
                    img.width = 100;//设置图片宽
                    img.height = 100;//设置图片高
                    document.getElementById("div1").appendChild(img);//把图片展示在页面上
                    $("#div1").append("<span  class='delete_img' data-id='" + imgName + "'>删除</span>");//添加一个删除按钮

                    var reader = new FileReader();
                    reader.onload = function (e) {
                        console.log(this.result);
                        imgobj[imgName] = this.result;//存储图片到对象中
                    }
                    reader.readAsDataURL(file);
                }
            });
            //点击删除按钮
            $(document).on("click", ".delete_img", function () {
                var _self = $(this),
                   _selfImgName = _self.attr("data-id");

                _self.prev().remove();
                _self.remove();//移除图片自己

                console.log(imgobj);
                delete imgobj[_selfImgName];//删除对象中的属性
                console.log(imgobj);

                // console.log(formData.get(_selfImgName)); 移除前
                formData.delete(_selfImgName);//移除formdata中的数据
                //console.log(formData.get(_selfImgName));  移除后

            });

            //点击完成，跳转到其他页面展示
            $("#btn").click(function (ev) {
                ev.preventDefault();
                console.log("btn");

                envObj.SaveLocals("imgobj", JSON.stringify(imgobj));//保存图片的src
                //formData  用于上传的时候传输的数据，如果不和后台交互，暂时不用
                window.location.href = "uploadimgformdataindex.html";
            });

            function getBase64Image(img) {
                var canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, img.width, img.height);
                var ext = img.src.substring(img.src.lastIndexOf(".") + 1).toLowerCase();
                var dataURL = canvas.toDataURL("image/" + ext);
                return dataURL;
            }

        });
    </script>
